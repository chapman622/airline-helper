<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Airline WP</title>
    <style>
        body {
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #keyBox {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 25px 35px;
            border-radius: 12px;
            border: 1px solid #555;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
            text-align: center;
            min-width: 400px;
            display: none;
            z-index: 9999;
        }
        h2 { margin-bottom: 18px; color: #4da6ff; }
        input {
            padding: 12px;
            width: 280px;
            font-size: 17px;
            border-radius: 6px;
            background: #111;
            color: #fff;
            border: 1px solid #666;
            display: block;
            margin: 0 auto 10px;
        }
        button {
            padding: 12px 24px;
            font-size: 17px;
            background: #007bff;
            color: #fff;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        #status { margin-top: 15px; min-height: 22px; }
        .error { color: #ff5555; }
        .success { color: #55ff99; }
        #refreshButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #28a745;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
        }
    </style>
</head>
<body>

<!-- AUTO CACHE-BUST (one-time, User App safe) -->
<script>
(function () {
    try {
        const url = new URL(window.location.href);
        if (!url.searchParams.has("v")) {
            url.searchParams.set("v", Date.now().toString());
            window.location.replace(url.toString());
        }
    } catch {}
})();
</script>

<div id="keyBox">
    <h2>Initial Setup (one-time)</h2>
    <input type="text" id="vrpId" placeholder="Your vRP ID" />
    <input type="password" id="apiKey" placeholder="Tycoon API key" />
    <button onclick="trySaveAndRun()">Save & Start</button>
    <div id="status"></div>
</div>

<div id="refreshButton">‚úàÔ∏è</div>

<script>
/* ================= CONFIG ================= */
const API_URL = 'https://tycoon-2epova.users.cfx.re/status/airline.json';
const KEY_STORAGE = 'tycoonAutoApiKey';
const VRP_STORAGE = 'tycoonVrpId';
const BURST_INTERVAL = 3000;
const MAX_BURST_CHECKS = 20;

/* ================= STATE ================= */
let burstTimer = null;
let burstCount = 0;
let isInBurstMode = false;
let lastNotification = null;
let lastDestSig = null;

const keyBox = document.getElementById('keyBox');
const statusEl = document.getElementById('status');
const keyInput = document.getElementById('apiKey');
const vrpInput = document.getElementById('vrpId');
const refreshBtn = document.getElementById('refreshButton');

/* ================= GAME DATA ================= */
window.addEventListener('message', (event) => {
    if (event.data?.type === 'dataUpdate') {
        const notif = event.data.data?.notification;
        if (notif && notif !== lastNotification) {
            lastNotification = notif;
            const n = notif.toLowerCase();
            if (n.includes('boarding complete') && n.includes('push back')) {
                console.log('üõ´ Boarding complete ‚Üí starting burst polling');
                startBurstPolling();
            }
        }
    }
});

/* ================= WAYPOINT ================= */
function setWaypoint(x, y) {
    window.parent.postMessage({
        type: "setWaypoint",
        x: Number(x),
        y: Number(y)
    }, "*");
}

/* ================= FETCH & CHECK ================= */
async function fetchAndSetWaypoint(key, vrpId, silent = false) {
    try {
        const res = await fetch(API_URL, {
            headers: { 'X-Tycoon-Key': key }
        });
        if (!res.ok) throw new Error('api');

        const data = await res.json();

        for (const route of Object.values(data)) {
            if (route[3].toString() === vrpId.toString()) {
                const dest = route[1];
                const destSig = `${dest.x}|${dest.y}|${dest.z}`;

                if (destSig !== lastDestSig) {
                    lastDestSig = destSig;

                    console.log('üß≠ Destination changed ‚Üí updating waypoint');
                    setWaypoint(dest.x, dest.y);

                    if (!silent) {
                        statusEl.textContent = `Waypoint: ${dest.name} (${dest.airport})`;
                        statusEl.className = 'success';
                    }

                    if (isInBurstMode) stopBurstPolling();
                }
                return true;
            }
        }

        return true;
    } catch (e) {
        if (!silent) {
            statusEl.textContent = 'API error / invalid key';
            statusEl.className = 'error';
        }
        return false;
    }
}

/* ================= BURST POLLING ================= */
function startBurstPolling() {
    if (isInBurstMode) return;

    const key = localStorage.getItem(KEY_STORAGE);
    const vrp = localStorage.getItem(VRP_STORAGE);
    if (!key || !vrp) return;

    isInBurstMode = true;
    burstCount = 0;

    fetchAndSetWaypoint(key, vrp, true);

    burstTimer = setInterval(() => {
        burstCount++;
        fetchAndSetWaypoint(key, vrp, true);

        if (burstCount >= MAX_BURST_CHECKS) {
            console.log('‚è± Burst timeout reached');
            stopBurstPolling();
        }
    }, BURST_INTERVAL);
}

function stopBurstPolling() {
    clearInterval(burstTimer);
    burstTimer = null;
    isInBurstMode = false;
    burstCount = 0;
    console.log('‚úÖ Burst polling stopped');
}

/* ================= INIT ================= */
async function trySaveAndRun() {
    const key = keyInput.value.trim();
    const vrp = vrpInput.value.trim();
    if (!key || !vrp) return;

    if (await fetchAndSetWaypoint(key, vrp)) {
        localStorage.setItem(KEY_STORAGE, key);
        localStorage.setItem(VRP_STORAGE, vrp);
        keyBox.style.display = 'none';
    }
}

async function autoRun() {
    const key = localStorage.getItem(KEY_STORAGE);
    const vrp = localStorage.getItem(VRP_STORAGE);
    if (key && vrp) {
        await fetchAndSetWaypoint(key, vrp);
    } else {
        keyBox.style.display = 'block';
    }
}

refreshBtn.onclick = () => {
    const key = localStorage.getItem(KEY_STORAGE);
    const vrp = localStorage.getItem(VRP_STORAGE);
    if (key && vrp) fetchAndSetWaypoint(key, vrp);
};

window.parent.postMessage({ type: "getData" }, "*");
autoRun();
</script>
</body>
</html>
