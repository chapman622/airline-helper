<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Airline WP</title>
    <style>
        body { background: transparent; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #keyBox {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); padding: 25px 35px; border-radius: 12px;
            border: 1px solid #555; box-shadow: 0 0 25px rgba(0,0,0,0.9);
            text-align: center; min-width: 400px; display: none; z-index: 9999;
        }
        h2 { margin: 0 0 18px; font-size: 21px; color: #4da6ff; }
        input[type="password"], input[type="text"] {
            padding: 12px; width: 280px; font-size: 17px; border: 1px solid #666;
            border-radius: 6px; background: #111; color: #fff; display: block; margin: 0 auto 10px;
        }
        button { padding: 12px 24px; font-size: 17px; margin-left: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #status { margin-top: 15px; font-size: 15px; min-height: 22px; }
        .error { color: #ff5555; } .success { color: #55ff99; }
        .hint { margin-top: 20px; font-size: 13px; color: #aaa; }
        #resetButton {
            position: fixed; bottom: 100px; left: 20px; width: 40px; height: 40px;
            cursor: pointer; z-index: 9999; opacity: 0.6; transition: opacity 0.3s;
            background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        #resetButton:hover { opacity: 1; }
        #resetButton span { font-size: 20px; }
    </style>
</head>
<body>

    <div id="keyBox">
        <h2>Initial Setup (one-time)</h2>
        <input type="text" id="vrpId" placeholder="Your vRP ID (e.g., 30197)" />
        <input type="password" id="apiKey" placeholder="Your private Tycoon API key" autofocus />
        <button onclick="trySaveAndRun()">Save & Start</button>
        <div id="status"></div>
        <div class="hint">Press ESC to pin/minimize • Enter to save</div>
    </div>

    <!-- Persistent re-set button -->
    <div id="resetButton" title="Re-set current waypoint">
        <span>✈️</span>
    </div>

    <!-- AUTO CACHE-BUST -->
    <script>
        (function() {
            const url = new URL(window.location.href);
            if (!url.searchParams.has("v")) {
                url.searchParams.set("v", Date.now());
                window.location.replace(url.toString());
            }
        })();
    </script>

    <script>
        // ================================================================
        // CONFIG & GLOBALS
        // ================================================================
        const API_URL = 'https://tycoon-2epova.users.cfx.re/status/airline.json';
        const KEY_STORAGE = 'tycoonAutoApiKey';
        const VRP_STORAGE = 'tycoonVrpId';

        let lastDestX = null;
        let lastDestY = null;

        const keyBox = document.getElementById('keyBox');
        const statusEl = document.getElementById('status');
        const keyInput = document.getElementById('apiKey');
        const vrpInput = document.getElementById('vrpId');
        const resetBtn = document.getElementById('resetButton');

        // ================================================================
        // HELPERS
        // ================================================================
        function setWaypoint(x, y) {
            const xNum = parseFloat(x);
            const yNum = parseFloat(y);
            const data = { type: "setWaypoint", x: xNum, y: yNum };

            window.parent.postMessage(data, "*");

            console.log('Waypoint set to:', xNum, yNum);
        }

        // ================================================================
        // Fetch & process airline data
        // ================================================================
        async function fetchAirlineData(key) {
            try {
                console.log('Fetching airline.json...');
                const res = await fetch(API_URL, {
                    headers: {
                        'X-Tycoon-Key': key,
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                    }
                });
                console.log('Fetch status:', res.status);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Fetch error:', err.message);
                throw err;
            }
        }

        async function getYourRoute(data, vrpId) {
            console.log('Processing API data for vRP ID:', vrpId);
            for (const r of Object.values(data)) {
                if (r[3].toString() === vrpId.toString()) {
                    console.log('Your route found:', r);
                    return r;
                }
            }
            console.log('No route found');
            return null;
        }

        async function tryUpdateWaypoint(key, vrpId) {
            try {
                const data = await fetchAirlineData(key);
                const route = await getYourRoute(data, vrpId);

                if (!route) return;

                const dest = route[1];
                const currX = parseFloat(dest.x);
                const currY = parseFloat(dest.y);

                if (lastDestX !== null && (currX !== lastDestX || currY !== lastDestY)) {
                    console.log('Destination changed! New:', dest.name, currX, currY);
                    setWaypoint(currX, currY);
                    statusEl.textContent = `Waypoint updated: ${dest.name} (${dest.airport}) ✓`;
                    statusEl.className = 'success';
                } else {
                    console.log('No destination change');
                }

                lastDestX = currX;
                lastDestY = currY;
                keyBox.style.display = 'none';
            } catch (err) {
                console.error('Update failed:', err.message);
                statusEl.textContent = 'Update failed – check F8';
                statusEl.className = 'error';
            }
        }

        // ================================================================
        // Message listener (from example)
        // ================================================================
        window.addEventListener("message", (event) => {
            const data = event.data?.data || event.data || {};
            console.log('Received message:', data);

            // Check for notification changes
            if (data.notification) {
                const text = data.notification;
                console.log('Notification received:', text);
                const lower = text.toLowerCase();
                if (lower.includes("boarding complete") || lower.includes("push back approved")) {
                    console.log('Boarding complete detected!');
                    statusEl.textContent = 'Boarding complete detected → updating waypoint...';
                    statusEl.className = 'success';
                    tryUpdateWaypoint(localStorage.getItem(KEY_STORAGE), localStorage.getItem(VRP_STORAGE));
                }
            }

            // Optional: Check job state
            if (data.job) {
                console.log('Current job:', data.job);
            }
        });

        // ================================================================
        // Save & initial run
        // ================================================================
        async function trySaveAndRun() {
            const key = keyInput.value.trim();
            const vrpId = vrpInput.value.trim();

            if (!vrpId || !key) {
                statusEl.textContent = !vrpId ? 'Enter vRP ID' : 'Enter API key';
                statusEl.className = 'error';
                return;
            }

            statusEl.textContent = 'Validating...';
            statusEl.className = '';

            await tryUpdateWaypoint(key, vrpId);

            localStorage.setItem(KEY_STORAGE, key);
            localStorage.setItem(VRP_STORAGE, vrpId);
            keyBox.style.display = 'none';
        }

        // ================================================================
        // Auto-run
        // ================================================================
        async function autoRun() {
            const key = localStorage.getItem(KEY_STORAGE);
            const vrpId = localStorage.getItem(VRP_STORAGE);

            if (key && vrpId) {
                vrpInput.value = vrpId;
                keyInput.value = key;
                await tryUpdateWaypoint(key, vrpId);
            } else {
                keyBox.style.display = 'block';
            }
        }

        // ================================================================
        // EVENTS
        // ================================================================
        window.addEventListener('keydown', e => {
            if (e.key === "Escape") {
                window.parent.postMessage({ type: "pin" }, "*");
                e.preventDefault();
            }
        });

        [keyInput, vrpInput].forEach(input => {
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    trySaveAndRun();
                }
            });
        });

        resetBtn.addEventListener('click', () => {
            const key = localStorage.getItem(KEY_STORAGE);
            const vrpId = localStorage.getItem(VRP_STORAGE);
            if (key && vrpId) {
                tryUpdateWaypoint(key, vrpId);
                statusEl.textContent = 'Re-set manually ✓';
                statusEl.className = 'success';
            }
        });

        // Request initial cached data
        window.parent.postMessage({ type: "getData" }, "*");
        console.log('Requested full cached data on load');

        autoRun();
    </script>
</body>
</html>
