<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Auto Airline WP</title>
<style>
body { background: transparent; color: #fff; font-family: Arial,sans-serif; margin:0; padding:0; overflow:hidden; }
#keyBox { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.85); padding:25px 35px; border-radius:12px; border:1px solid #555; box-shadow:0 0 25px rgba(0,0,0,0.9); text-align:center; min-width:400px; display:none; z-index:9999; }
h2 { margin:0 0 18px; font-size:21px; color:#4da6ff; }
input[type=password],input[type=text] { padding:12px; width:280px; font-size:17px; border:1px solid #666; border-radius:6px; background:#111; color:#fff; display:block; margin:0 auto 10px; }
button { padding:12px 24px; font-size:17px; margin:5px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#0056b3; }
#status { margin-top:15px; font-size:15px; min-height:22px; }
.error { color:#ff5555; }
.success { color:#55ff99; }
.hint { margin-top:20px; font-size:13px; color:#aaa; }
#refreshButton { 
  position:fixed; bottom:100px; left:20px; width:50px; height:50px; cursor:move; z-index:9999; 
  opacity:0.7; transition:opacity 0.3s; background:#28a745; border-radius:50%; display:flex; 
  align-items:center; justify-content:center; font-size:24px; border:2px solid #1e7e34; 
  user-select:none; 
}
#refreshButton:hover { opacity:1; transform:scale(1.1); transition:all 0.2s; }
#refreshButton.dragging { cursor:grabbing; opacity:1; }
</style>
</head>
<body>

<div id="keyBox">
    <h2>Initial Setup (one-time)</h2>
    <input type="text" id="vrpId" placeholder="Your vRP ID (e.g., 30197)" />
    <input type="password" id="apiKey" placeholder="Your private Tycoon API key" autofocus />
    <button onclick="trySaveAndRun()">Save & Start</button>
    <div id="status"></div>
    <div class="hint">Press ESC to pin/minimize ‚Ä¢ Enter to save</div>
</div>

<div id="refreshButton" title="Refresh waypoint now">‚úàÔ∏è</div>

<!-- AUTO CACHE-BUST -->
<script>
(function() {
    const url = new URL(location.href);
    if (!url.searchParams.has("v")) {
        url.searchParams.set("v", Date.now());
        location.replace(url);
    }
})();
</script>

<script>
// ================================
// CONFIG & GLOBALS
// ================================
const API_URL = 'https://tycoon-2epova.users.cfx.re/status/airline.json';
const KEY_STORAGE = 'tycoonAutoApiKey';
const VRP_STORAGE = 'tycoonVrpId';
const BTN_POS_STORAGE = 'tycoonBtnPosition';
const BURST_INTERVAL = 3000;
const MAX_BURST_CHECKS = 20;

// GLOBALS
let burstTimer = null;
let burstCount = 0;
let isInBurstMode = false;
let lastNotification = null;
let lastX = null;
let lastY = null;
let lastZ = null;
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let isAirlinePilot = false;
let jobCheckTimeout = null; // For debounce

const keyBox = document.getElementById('keyBox');
const statusEl = document.getElementById('status');
const keyInput = document.getElementById('apiKey');
const vrpInput = document.getElementById('vrpId');
const refreshBtn = document.getElementById('refreshButton');

// ================================
// JOB DETECTION WITH DEBOUNCE
// ================================
function checkJob(job, jobName, jobTitle, subJob, subJobName) {
    console.log('Job check - received full:', { job, jobName, jobTitle, subJob, subJobName });
    
    // Clear any pending timeout
    if (jobCheckTimeout) clearTimeout(jobCheckTimeout);
    
    // Debounce: wait 1 second for all rapid messages to settle
    jobCheckTimeout = setTimeout(() => {
        const allNames = [
            job || '',
            jobName || '',
            jobTitle || '',
            subJob || '',
            subJobName || ''
        ].join(' ').toLowerCase();
        
        const wasAirline = isAirlinePilot;
        
        // Flexible match for "Airline Pilot" display name or internal variants
        isAirlinePilot = allNames.includes('airline pilot') || 
                         allNames.includes('airlinepilot') || 
                         allNames.includes('airline');
        
        console.log('Debounced job check - all names:', allNames);
        console.log('Result - isAirlinePilot:', isAirlinePilot, '(was:', wasAirline, ')');
        
        if (isAirlinePilot !== wasAirline) {
            if (isAirlinePilot) {
                console.log('‚úàÔ∏è Airline Pilot detected - ACTIVATING');
                refreshBtn.style.display = 'flex';
                sendDebug('‚úàÔ∏è Airline app activated');
            } else {
                console.log('‚ùå Not airline pilot - DEACTIVATING');
                refreshBtn.style.display = 'none';
                sendDebug('Airline app deactivated');
                if (isInBurstMode) {
                    stopBurstPolling();
                }
            }
        }
    }, 1000); // 1 second delay
}

function sendDebug(text) {
    window.parent.postMessage({ type: "notification", text: text }, "*");
    console.log('DEBUG: ' + text);
}

// Set waypoint
function setWaypoint(x, y, z) {
    const waypointData = {
        type: "setWaypoint",
        x: parseFloat(x),
        y: parseFloat(y),
        z: parseFloat(z)
    };
    window.postMessage(waypointData, "*");
    if (window.parent !== window) window.parent.postMessage(waypointData, "*");
    sendDebug('Waypoint set: ' + x.toFixed(1) + ', ' + y.toFixed(1) + ', ' + z.toFixed(1));
}

// Fetch & update waypoint
async function fetchAndSetWaypoint(key, vrpId, isSilent = false) {
    try {
        console.log('Fetch started');
        const response = await fetch(API_URL, { headers: { 'X-Tycoon-Key': key } });
        console.log('Fetch status:', response.status);
        if (!response.ok) throw new Error(response.status === 401 ? 'invalid_key' : 'api_error');
        const data = await response.json();
        console.log('API data received');
        
        let yourRoute = null;
        for (const [routeNum, routeData] of Object.entries(data)) {
            if (routeData[3].toString() === vrpId.toString()) {
                yourRoute = routeData;
                console.log('Found your route:', routeNum);
                break;
            }
        }
        
        if (yourRoute) {
            const dest = yourRoute[1];
            const currX = parseFloat(dest.x).toFixed(2);
            const currY = parseFloat(dest.y).toFixed(2);
            const currZ = parseFloat(dest.z).toFixed(2);
            
            console.log('Current coords:', currX, currY, currZ);
            console.log('Last coords:', lastX, lastY, lastZ);
            
            if (lastX !== currX || lastY !== currY || lastZ !== currZ) {
                console.log('‚úì WAYPOINT CHANGED!');
                setWaypoint(dest.x, dest.y, dest.z);
                lastX = currX;
                lastY = currY;
                lastZ = currZ;
                
                if (!isSilent) {
                    statusEl.textContent = `Waypoint: ${dest.name} (${dest.airport}) ‚úì`;
                    statusEl.className = 'success';
                }
                
                refreshBtn.style.background = '#00ff00';
                setTimeout(() => { refreshBtn.style.background = '#28a745'; }, 500);
                
                if (isInBurstMode) {
                    console.log('Stopping burst - waypoint updated');
                    stopBurstPolling();
                }
            } else {
                console.log('Same waypoint, no change');
            }
        } else {
            console.log('No active route for vRP ID:', vrpId);
            lastX = lastY = lastZ = null;
            if (!isSilent) {
                statusEl.textContent = 'No active airline route';
                statusEl.className = '';
            }
        }
        
        if (!isSilent) keyBox.style.display = 'none';
        return true;
    } catch (err) {
        console.error('Fetch error:', err.message);
        if (!isSilent) {
            statusEl.className = 'error';
            statusEl.textContent = err.message === 'invalid_key' ? 'Invalid API key' : 'API error';
        }
        sendDebug('Fetch error: ' + err.message);
        return false;
    }
}

// Start burst polling
function startBurstPolling() {
    if (!isAirlinePilot) {
        console.log('Not airline pilot - burst cancelled');
        return;
    }
    
    if (isInBurstMode) {
        console.log('Already in burst mode, ignoring');
        return;
    }
    
    isInBurstMode = true;
    burstCount = 0;
    
    const key = localStorage.getItem(KEY_STORAGE);
    const vrpId = localStorage.getItem(VRP_STORAGE);
    
    if (!key || !vrpId) {
        sendDebug('No saved key/vrpId');
        console.log('Missing credentials, cannot start burst');
        return;
    }
    
    console.log('üî• BURST POLLING STARTED');
    sendDebug('üî• Burst polling started');
    
    // Immediate check
    fetchAndSetWaypoint(key, vrpId, true);
    
    // Then check every 3 seconds
    burstTimer = setInterval(() => {
        burstCount++;
        console.log(`Burst check ${burstCount}/${MAX_BURST_CHECKS}`);
        sendDebug(`Burst check ${burstCount}/${MAX_BURST_CHECKS}`);
        
        fetchAndSetWaypoint(key, vrpId, true);
        
        if (burstCount >= MAX_BURST_CHECKS) {
            console.log('Max burst reached, stopping');
            sendDebug('Max burst reached, stopping');
            stopBurstPolling();
        }
    }, BURST_INTERVAL);
    
    refreshBtn.style.background = '#ffa500';
}

function stopBurstPolling() {
    if (burstTimer) {
        clearInterval(burstTimer);
        burstTimer = null;
    }
    isInBurstMode = false;
    burstCount = 0;
    refreshBtn.style.background = '#28a745';
    console.log('‚úÖ Burst polling stopped');
    sendDebug('‚úÖ Burst stopped');
}

// Save & run
async function trySaveAndRun() {
    const key = keyInput.value.trim();
    const vrpId = vrpInput.value.trim();
    if (!vrpId || !key) {
        statusEl.textContent = !vrpId ? 'Enter vRP ID' : 'Enter API key';
        statusEl.className = 'error';
        return;
    }
    statusEl.textContent = 'Validating...';
    statusEl.className = '';
    if (await fetchAndSetWaypoint(key, vrpId, false)) {
        localStorage.setItem(KEY_STORAGE, key);
        localStorage.setItem(VRP_STORAGE, vrpId);
        sendDebug('Setup complete - listening for notifications');
    }
}

// Auto-run
async function autoRun() {
    const key = localStorage.getItem(KEY_STORAGE);
    const vrpId = localStorage.getItem(VRP_STORAGE);
    if (key && vrpId) {
        vrpInput.value = vrpId;
        keyInput.value = key;
        await fetchAndSetWaypoint(key, vrpId, false);
        console.log('App loaded - listening for boarding notifications');
    } else {
        keyBox.style.display = 'block';
    }
}

// EVENTS
window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        window.parent.postMessage({ type: 'pin' }, '*');
        e.preventDefault();
    }
});

[keyInput, vrpInput].forEach(input => {
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            trySaveAndRun();
        }
    });
});

refreshBtn.addEventListener('mousedown', (e) => {
    isDragging = true;
    dragOffsetX = e.clientX - refreshBtn.offsetLeft;
    dragOffsetY = e.clientY - refreshBtn.offsetTop;
    refreshBtn.classList.add('dragging');
    e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    const newLeft = e.clientX - dragOffsetX;
    const newTop = e.clientY - dragOffsetY;
    
    const maxLeft = window.innerWidth - refreshBtn.offsetWidth;
    const maxTop = window.innerHeight - refreshBtn.offsetHeight;
    
    refreshBtn.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
    refreshBtn.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
    refreshBtn.style.bottom = 'auto';
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        refreshBtn.classList.remove('dragging');
        
        const position = {
            left: refreshBtn.style.left,
            top: refreshBtn.style.top
        };
        localStorage.setItem(BTN_POS_STORAGE, JSON.stringify(position));
        console.log('Button position saved:', position);
    }
});

// Restore saved button position
function restoreButtonPosition() {
    const saved = localStorage.getItem(BTN_POS_STORAGE);
    if (saved) {
        try {
            const pos = JSON.parse(saved);
            if (pos.left) refreshBtn.style.left = pos.left;
            if (pos.top) {
                refreshBtn.style.top = pos.top;
                refreshBtn.style.bottom = 'auto';
            }
            console.log('Button position restored:', pos);
        } catch (e) {
            console.log('Failed to restore button position');
        }
    }
}

// Message listener
window.addEventListener("message", (event) => {
    const data = event.data?.data;
    if (!data || typeof data !== 'object') return;
    
    console.log('Message received, keys:', Object.keys(data));
    
    // Job detection with debounce
    checkJob(data.job, data.job_name, data.job_title, data.subjob, data.subjob_name);
    
    if (data.notification && data.notification !== lastNotification) {
        lastNotification = data.notification;
        
        const lower = data.notification.toLowerCase();
        if (lower.includes('boarding complete') && lower.includes('push back approved')) {
            if (!isAirlinePilot) return;
            
            console.log('üõ´ BOARDING COMPLETE DETECTED:', data.notification);
            sendDebug('üõ´ Boarding complete - starting burst...');
            startBurstPolling();
        }
    }
});

// Request initial cached data
window.parent.postMessage({ type: "getData" }, "*");
console.log('Requested initial game data on load');

// Force request job fields
window.parent.postMessage({ type: "getNamedData", keys: ["job", "job_name", "job_title", "subjob", "subjob_name"] }, "*");
console.log('Requested job fields on load');

// Register keybind (optional)
window.parent.postMessage({
    type: "registerTrigger",
    trigger: "airline_reset_waypoint",
    name: "Airline: Re-set Waypoint"
}, "*");
console.log('Keybind registered: airline_reset_waypoint');

// Restore button position
restoreButtonPosition();

// Hide button initially
refreshBtn.style.display = 'none';

// Start the app
autoRun();
</script>
</body>
</html>
