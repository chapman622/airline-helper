<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Auto Airline WP</title>

<style>
body {
    background: transparent;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0;
    overflow: hidden;
}
#keyBox {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,.85);
    padding: 25px 35px;
    border-radius: 12px;
    min-width: 400px;
    display: none;
    z-index: 9999;
}
input {
    padding: 12px;
    width: 280px;
    margin: 6px auto;
    display: block;
    background: #111;
    color: #fff;
    border: 1px solid #666;
    border-radius: 6px;
}
button {
    padding: 12px 24px;
    margin-top: 8px;
    font-size: 16px;
    background: #007bff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
#status { margin-top: 12px; min-height: 20px; }
.success { color: #55ff99; }
.error { color: #ff6666; }

#refreshButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: #28a745;
    border: 2px solid #1e7e34;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>

<body>

<div id="keyBox">
    <h2>Initial Setup</h2>
    <input id="vrpId" placeholder="Your vRP ID">
    <input id="apiKey" type="password" placeholder="Tycoon API Key">
    <button onclick="trySaveAndRun()">Save & Start</button>
    <div id="status"></div>
</div>

<div id="refreshButton">‚úàÔ∏è</div>

<!-- AUTO CACHE BUST -->
<script>
(function(){
    const u=new URL(location.href);
    if(!u.searchParams.has("v")){
        u.searchParams.set("v",Date.now());
        location.replace(u);
    }
})();
</script>

<script>
/* =======================================================
   CONFIG
======================================================= */
const API_URL = 'https://tycoon-2epova.users.cfx.re/status/airline.json';
const KEY_STORAGE = 'tycoonAutoApiKey';
const VRP_STORAGE = 'tycoonVrpId';

const BURST_INTERVAL = 3000;
const MAX_BURST_CHECKS = 20;

/* =======================================================
   STATE
======================================================= */
let lastDestSig = null;
let lastNotification = '';
let isInBurstMode = false;
let burstTimer = null;
let burstCount = 0;

/* =======================================================
   ELEMENTS
======================================================= */
const keyBox = document.getElementById('keyBox');
const statusEl = document.getElementById('status');
const refreshBtn = document.getElementById('refreshButton');
const keyInput = document.getElementById('apiKey');
const vrpInput = document.getElementById('vrpId');

/* =======================================================
   SAFE DEBUG (FiveM)
======================================================= */
function notify(text){
    window.parent.postMessage({
        type: "info",
        text,
        time: 3
    },"*");
}

/* =======================================================
   WAYPOINT
======================================================= */
function setWaypoint(x,y,z){
    const msg={ type:"setWaypoint", x:+x, y:+y, z:+z };
    window.postMessage(msg,"*");
    window.parent.postMessage(msg,"*");
}

/* =======================================================
   FETCH & COMPARE
======================================================= */
async function fetchAndSetWaypoint(key, vrp, silent=false){
    const r = await fetch(API_URL,{ headers:{'X-Tycoon-Key':key}});
    if(!r.ok) return;

    const data = await r.json();

    for(const route of Object.values(data)){
        if(route[3].toString() === vrp.toString()){
            const d = route[1];
            const sig = `${d.x}|${d.y}|${d.z}`;

            if(sig !== lastDestSig){
                lastDestSig = sig;
                setWaypoint(d.x,d.y,d.z);

                if(!silent){
                    statusEl.textContent = `Waypoint set: ${d.name}`;
                    statusEl.className = 'success';
                }

                notify("‚úàÔ∏è New destination detected");
                stopBurstPolling();
            }
            return;
        }
    }
}

/* =======================================================
   BURST POLLING (FIXED)
======================================================= */
function startBurstPolling(){
    if(isInBurstMode) return;

    const key = localStorage.getItem(KEY_STORAGE);
    const vrp = localStorage.getItem(VRP_STORAGE);
    if(!key||!vrp) return;

    isInBurstMode = true;
    burstCount = 0;

    // üîë CRITICAL FIX
    lastDestSig = null;

    notify("Boarding complete ‚Äì waiting for new route");

    fetchAndSetWaypoint(key,vrp,true);

    burstTimer = setInterval(()=>{
        burstCount++;
        fetchAndSetWaypoint(key,vrp,true);

        if(burstCount >= MAX_BURST_CHECKS){
            stopBurstPolling();
        }
    },BURST_INTERVAL);
}

function stopBurstPolling(){
    if(burstTimer) clearInterval(burstTimer);
    burstTimer=null;
    isInBurstMode=false;
}

/* =======================================================
   GAME DATA LISTENER
======================================================= */
window.addEventListener('message',e=>{
    if(e.data?.type==='dataUpdate'){
        const n=e.data.data?.notification;
        if(n && n!==lastNotification){
            lastNotification=n;
            if(n.toLowerCase().includes('boarding complete')){
                startBurstPolling();
            }
        }
    }
});

/* =======================================================
   SETUP
======================================================= */
async function trySaveAndRun(){
    const key=keyInput.value.trim();
    const vrp=vrpInput.value.trim();
    if(!key||!vrp) return;

    localStorage.setItem(KEY_STORAGE,key);
    localStorage.setItem(VRP_STORAGE,vrp);

    await fetchAndSetWaypoint(key,vrp,false);
    keyBox.style.display='none';
}

async function autoRun(){
    const key=localStorage.getItem(KEY_STORAGE);
    const vrp=localStorage.getItem(VRP_STORAGE);

    if(key&&vrp){
        keyInput.value=key;
        vrpInput.value=vrp;
        await fetchAndSetWaypoint(key,vrp,false);
    } else {
        keyBox.style.display='block';
    }
}

refreshBtn.onclick=()=>{
    const key=localStorage.getItem(KEY_STORAGE);
    const vrp=localStorage.getItem(VRP_STORAGE);
    if(key&&vrp) fetchAndSetWaypoint(key,vrp,false);
};

window.parent.postMessage({type:"getData"},"*");
autoRun();
</script>
</body>
</html>
