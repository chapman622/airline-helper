<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Airline WP</title>
    <style>
        body {
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #keyBox {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 25px 35px;
            border-radius: 12px;
            border: 1px solid #555;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
            text-align: center;
            min-width: 400px;
            display: none;
            z-index: 9999;
        }
        h2 {
            margin: 0 0 18px;
            font-size: 21px;
            color: #4da6ff;
        }
        input[type="password"],
        input[type="text"] {
            padding: 12px;
            width: 280px;
            font-size: 17px;
            border: 1px solid #666;
            border-radius: 6px;
            background: #111;
            color: #fff;
            display: block;
            margin: 0 auto 10px;
        }
        button {
            padding: 12px 24px;
            font-size: 17px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #status {
            margin-top: 15px;
            font-size: 15px;
            min-height: 22px;
        }
        .error { color: #ff5555; }
        .success { color: #55ff99; }
        .hint {
            margin-top: 20px;
            font-size: 13px;
            color: #aaa;
        }
        #refreshButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 9999;
            opacity: 0.7;
            transition: opacity 0.3s;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid #1e7e34;
        }
        #refreshButton:hover { 
            opacity: 1;
            transform: scale(1.1);
            transition: all 0.2s;
        }
    </style>
</head>
<body>

    <div id="keyBox">
        <h2>Initial Setup (one-time)</h2>
        <input type="text" id="vrpId" placeholder="Your vRP ID (e.g., 30197)" />
        <input type="password" id="apiKey" placeholder="Your private Tycoon API key" autofocus />
        <button onclick="trySaveAndRun()">Save & Start</button>
        <div id="status"></div>
        <div class="hint">Press ESC to pin/minimize ‚Ä¢ Enter to save</div>
    </div>

    <!-- Manual refresh button -->
    <div id="refreshButton" title="Refresh waypoint now">
        ‚úàÔ∏è
    </div>

    <!-- AUTO CACHE-BUST -->
    <script>
        (function() {
            const url = new URL(location.href);
            if (!url.searchParams.has("v")) {
                url.searchParams.set("v", Date.now());
                location.replace(url);
            }
        })();
    </script>

    <script>
        // ================================================================
        // CONFIG & GLOBALS
        // ================================================================
        const API_URL = 'https://tycoon-2epova.users.cfx.re/status/airline.json';
        const KEY_STORAGE = 'tycoonAutoApiKey';
        const VRP_STORAGE = 'tycoonVrpId';
        const BURST_INTERVAL = 3000;
        const MAX_BURST_CHECKS = 20; // Max 60 seconds of checking

        let burstTimer = null;
        let burstCount = 0;
        let lastRouteId = null;
        let lastNotification = '';
        let isInBurstMode = false;

        const keyBox = document.getElementById('keyBox');
        const statusEl = document.getElementById('status');
        const keyInput = document.getElementById('apiKey');
        const vrpInput = document.getElementById('vrpId');
        const refreshBtn = document.getElementById('refreshButton');

        // ================================================================
        // LISTEN TO GAME DATA
        // ================================================================
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'dataUpdate') {
                const data = event.data.data;
                
                // Check for notification updates
                if (data.notification && data.notification !== lastNotification) {
                    lastNotification = data.notification;
                    console.log('Notification received:', data.notification);
                    
                    // Check if it's the boarding notification
                    const notifLower = data.notification.toLowerCase();
                    if (notifLower.includes('boarding complete') && notifLower.includes('push back')) {
                        console.log('üõ´ BOARDING COMPLETE DETECTED! Starting burst polling...');
                        startBurstPolling();
                    }
                }
            }
        });

        // ================================================================
        // HELPERS
        // ================================================================
        function setWaypoint(x, y, z) {
            const waypointData = {
                type: "setWaypoint",
                x: parseFloat(x),
                y: parseFloat(y),
                z: parseFloat(z)
            };
            
            window.postMessage(waypointData, "*");
            if (window.parent !== window) {
                window.parent.postMessage(waypointData, "*");
            }
            
            console.log('Waypoint set:', waypointData);
        }

        // ================================================================
        // FETCH & UPDATE WAYPOINT
        // ================================================================
        async function fetchAndSetWaypoint(key, vrpId, isSilent = false) {
            try {
                const response = await fetch(API_URL, {
                    headers: { 'X-Tycoon-Key': key }
                });

                if (!response.ok) {
                    throw new Error(response.status === 401 ? 'invalid_key' : 'api_error');
                }

                const data = await response.json();
                
                // Filter to your route
                let yourRoute = null;
                let routeId = null;
                for (const [routeNum, routeData] of Object.entries(data)) {
                    if (routeData[3].toString() === vrpId.toString()) {
                        yourRoute = routeData;
                        routeId = routeNum;
                        break;
                    }
                }

                if (yourRoute) {
                    const dest = yourRoute[1];
                    
                    // Check if route changed
                    if (routeId !== lastRouteId) {
                        setWaypoint(dest.x, dest.y, dest.z);
                        lastRouteId = routeId;
                        
                        console.log('‚úì NEW ROUTE DETECTED:', routeId, dest.name);
                        
                        if (!isSilent) {
                            statusEl.textContent = `Waypoint: ${dest.name} (${dest.airport}) ‚úì`;
                            statusEl.className = 'success';
                        }
                        
                        // Flash button
                        refreshBtn.style.background = '#00ff00';
                        setTimeout(() => {
                            refreshBtn.style.background = '#28a745';
                        }, 500);
                        
                        // STOP burst mode - we found the new route!
                        if (isInBurstMode) {
                            console.log('Route changed - stopping all polling');
                            stopBurstPolling();
                        }
                        
                        return true; // Signal that route changed
                    } else if (!isSilent) {
                        console.log('Same route, no change');
                    }
                } else {
                    lastRouteId = null;
                    if (!isSilent) {
                        statusEl.textContent = 'No active airline route';
                        statusEl.className = '';
                    }
                }

                if (!isSilent) {
                    keyBox.style.display = 'none';
                }
                return true;

            } catch (err) {
                console.error('Fetch error:', err);
                if (!isSilent) {
                    statusEl.className = 'error';
                    statusEl.textContent = err.message === 'invalid_key' ? 'Invalid API key' : 'API error';
                }
                return false;
            }
        }

        // ================================================================
        // BURST POLLING (after boarding notification)
        // Only checks until waypoint changes, then stops
        // ================================================================
        function startBurstPolling() {
            if (isInBurstMode) {
                console.log('Already in burst mode, skipping');
                return;
            }
            
            isInBurstMode = true;
            burstCount = 0;
            
            const key = localStorage.getItem(KEY_STORAGE);
            const vrpId = localStorage.getItem(VRP_STORAGE);
            
            if (!key || !vrpId) return;
            
            console.log('Starting burst polling - will stop when waypoint changes');
            
            // Immediate check
            fetchAndSetWaypoint(key, vrpId, true);
            
            // Then check every 3 seconds until route changes or max attempts
            burstTimer = setInterval(() => {
                burstCount++;
                console.log(`Burst check ${burstCount}/${MAX_BURST_CHECKS}`);
                
                fetchAndSetWaypoint(key, vrpId, true);
                
                // Stop if max attempts reached (safety)
                if (burstCount >= MAX_BURST_CHECKS) {
                    console.log('Max burst checks reached - stopping');
                    stopBurstPolling();
                }
                // Note: also stops automatically when route changes (in fetchAndSetWaypoint)
            }, BURST_INTERVAL);
            
            refreshBtn.style.background = '#ffa500'; // Orange during burst
        }

        function stopBurstPolling() {
            if (burstTimer) {
                clearInterval(burstTimer);
                burstTimer = null;
            }
            isInBurstMode = false;
            burstCount = 0;
            refreshBtn.style.background = '#28a745';
            console.log('‚úì Burst polling stopped - waiting for next boarding notification');
        }

        // ================================================================
        // NORMAL AUTO-REFRESH - REMOVED
        // Now only checks after boarding notification (burst mode)
        // ================================================================

        // ================================================================
        // SAVE & INITIAL RUN
        // ================================================================
        async function trySaveAndRun() {
            const key = keyInput.value.trim();
            const vrpId = vrpInput.value.trim();
            
            if (!vrpId || !key) {
                statusEl.textContent = !vrpId ? 'Enter vRP ID' : 'Enter API key';
                statusEl.className = 'error';
                return;
            }

            statusEl.textContent = 'Validating...';
            statusEl.className = '';

            if (await fetchAndSetWaypoint(key, vrpId, false)) {
                localStorage.setItem(KEY_STORAGE, key);
                localStorage.setItem(VRP_STORAGE, vrpId);
                console.log('Initial setup complete - waiting for boarding notifications');
            }
        }

        // ================================================================
        // AUTO-RUN ON LOAD
        // ================================================================
        async function autoRun() {
            const key = localStorage.getItem(KEY_STORAGE);
            const vrpId = localStorage.getItem(VRP_STORAGE);

            if (key && vrpId) {
                vrpInput.value = vrpId;
                keyInput.value = key;
                
                const success = await fetchAndSetWaypoint(key, vrpId, false);
                if (success) {
                    console.log('App loaded - listening for boarding notifications');
                } else {
                    keyBox.style.display = 'block';
                    statusEl.textContent = 'Saved credentials invalid';
                    statusEl.className = 'error';
                }
            } else {
                keyBox.style.display = 'block';
            }
        }

        // ================================================================
        // EVENT LISTENERS
        // ================================================================
        window.addEventListener('keydown', e => {
            if (e.key === "Escape") {
                window.parent.postMessage({ type: "pin" }, "*");
                e.preventDefault();
            }
        });

        [keyInput, vrpInput].forEach(input => {
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    trySaveAndRun();
                }
            });
        });

        refreshBtn.addEventListener('click', () => {
            const key = localStorage.getItem(KEY_STORAGE);
            const vrpId = localStorage.getItem(VRP_STORAGE);
            if (key && vrpId) {
                console.log('Manual refresh triggered');
                fetchAndSetWaypoint(key, vrpId, false);
            }
        });

        // ================================================================
        // REQUEST INITIAL DATA
        // ================================================================
        window.parent.postMessage({ type: "getData" }, "*");
        console.log('Requested initial game data');

        // Start the app
        autoRun();
    </script>
</body>
</html>
